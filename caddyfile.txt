# The Caddyfile is an easy way to configure your Caddy web server.
#
# Unless the file starts with a global options block, the first
# uncommented line is always the address of your site.
#
# To use your own domain name (with automatic HTTPS), first make
# sure your domain's A/AAAA DNS records are properly pointed to
# this machine's public IP, then replace ":80" below with your
# domain name.
#
# Refer to the Caddy docs for more information:
# https://caddyserver.com/docs/caddyfile
erpro.kwucsalabs.dedyn.io {
    route {
        # 1) API 먼저 처리
        @api {
            path /api/*
        }
        handle @api {
            reverse_proxy http://127.0.0.1:8080
        }
        # 2) SPA 정적 파일 처리
        handle {
            root * /opt/erpro/front
            file_server
            try_files {path} /index.html
        }
    }
}
goodokm.kwucsalabs.dedyn.io {
    route {
        @api {
            path /api/*
        }
        handle @api {
            reverse_proxy http://127.0.0.1:8081
        }
        handle {
            reverse_proxy http://127.0.0.1:3000
        }
    }
}

code.kwucsalabs.dedyn.io {
	encode zstd gzip
	reverse_proxy 127.0.0.1:10080
}

n8n.kwucsalabs.dedyn.io {
	encode zstd gzip
	reverse_proxy 127.0.0.1:5678
}
# project-a.kwucsalabs.dedyn.io {
# 	encode zstd gzip
# 	reverse_proxy 127.0.0.1:8080
# }
allow.kwucsalabs.dedyn.io {
	encode zstd gzip
	root * /var/www/allowance

	# 매처 (캐시 정책용)
	@assets {
		path *.js *.css *.png *.jpg *.jpeg *.gif *.svg *.webp *.ico *.woff *.woff2
	}
	@html {
		path / /index.html *.html
	}

	# ---------- 라우팅 순서 고정 ----------
	route {
		# 1) API 먼저 처리 (프리픽스 제거하지 않음!)
		handle /api/* {
			reverse_proxy 127.0.0.1:3001
		}

		# 2) 나머지는 SPA 정적 처리
		handle {
			header @html Cache-Control "no-cache"
			header @assets Cache-Control "public, max-age=31536000, immutable"
			try_files {path} /index.html
			file_server
		}
	}
}
